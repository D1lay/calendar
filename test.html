<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Демо Mini App</title>

  <!-- ВСЕГДА в <head> до других скриптов -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; background: #111; color: #eee; }
    .card { background: #1b1b1b; border-radius: 14px; padding: 16px; box-shadow: 0 4px 20px rgba(0,0,0,.35); }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .row { margin: 10px 0; }
    button { padding: 12px 16px; border: 0; border-radius: 10px; background: #2a84ff; color: #fff; font-weight: 600; cursor: pointer; }
    button:active { transform: translateY(1px); }
    pre { background: #0c0c0c; border-radius: 10px; padding: 10px; max-height: 280px; overflow: auto; white-space: pre-wrap; word-break: break-word; font-size: 12px; }
    .muted { opacity: .8; font-size: 13px; }
    .ok { color: #84ff94; }
    .warn { color: #ffd66b; }
    .err { color: #ff6b6b; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Демо Mini App</h1>
    <div class="row muted">Показывает имя и отправляет его обратно в бот через <code>sendData()</code>.</div>
    <div id="name" class="row">Ваше имя — ...</div>
    <div class="row">
      <button id="sendBtn">Отправить</button>
    </div>
  </div>

  <div class="card" style="margin-top: 14px;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h1>Debug log</h1>
      <button id="clearBtn" style="background:#3a3a3a;">Очистить</button>
    </div>
    <pre id="log"></pre>
  </div>

  <script>
    // --- гибкий логгер с перехватом ошибок
    const logEl = document.getElementById('log');
    function log(title, obj = null, cls = '') {
      const time = new Date().toLocaleTimeString();
      const line = document.createElement('div');
      if (cls) line.className = cls;
      line.textContent = `[${time}] ${title}`;
      logEl.appendChild(line);
      if (obj !== null) {
        const block = document.createElement('div');
        block.innerHTML = `<pre>${escapeHtml(JSON.stringify(obj, null, 2))}</pre>`;
        logEl.appendChild(block);
      }
      logEl.scrollTop = logEl.scrollHeight;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    window.addEventListener('error', e => log(`JS Error: ${e.message}`, {stack: e.error?.stack}, 'err'));
    window.addEventListener('unhandledrejection', e => log(`Unhandled Rejection`, {reason: e.reason}, 'err'));

    const urlParams = new URLSearchParams(location.search);
    const urlName = (urlParams.get('name') || '').trim();

    // Состояние
    let displayName = 'Гость';

    function isRealTelegramEnv(tg) {
      if (!tg) return false;
      // В реальном окружении внутри Telegram непустой initData или есть user/query_id
      const hasInitData = typeof tg.initData === 'string' && tg.initData.length > 0;
      const hasUnsafe = tg.initDataUnsafe && (tg.initDataUnsafe.query_id || tg.initDataUnsafe.user);
      const notUnknownPlatform = tg.platform && tg.platform !== 'unknown';
      return Boolean(hasInitData || hasUnsafe || notUnknownPlatform);
    }

    function waitForTelegram(maxWaitMs = 3000, stepMs = 50) {
      return new Promise(resolve => {
        const started = Date.now();
        const tryDetect = () => {
          const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
          if (tg && isRealTelegramEnv(tg)) return resolve(tg);
          if (Date.now() - started >= maxWaitMs) return resolve(null);
          setTimeout(tryDetect, stepMs);
        };
        tryDetect();
      });
    }

    async function init() {
      log('DOM loaded', null, 'ok');

      const tg = await waitForTelegram();
      if (!tg) {
        // Не в Telegram — работаем в браузере
        log('Telegram WebApp object not found. Running in browser?', null, 'warn');
        displayName = urlName || 'Гость';
        document.getElementById('name').textContent = `Ваше имя — ${displayName}`;
        log('Имя получено из URL', { name: displayName });
        bindUi(null);
        return;
      }

      // В Telegram
      try {
        tg.ready();
        tg.expand();
        log('Telegram WebApp initialized', { version: tg.version, platform: tg.platform, colorScheme: tg.colorScheme });
        log('tg.initDataUnsafe', tg.initDataUnsafe || {});

        const u = tg.initDataUnsafe?.user;
        displayName = [u?.first_name, u?.last_name].filter(Boolean).join(' ')
                      || u?.username
                      || urlName
                      || 'Гость';
        document.getElementById('name').textContent = `Ваше имя — ${displayName}`;

        tg.onEvent('themeChanged', () => log('themeChanged', { theme: tg.themeParams }));
        tg.onEvent('viewportChanged', ev => log('viewportChanged', ev));
        tg.onEvent('mainButtonClicked', () => log('mainButtonClicked'));

        bindUi(tg);
      } catch (e) {
        log('Init error', { message: e.message, stack: e.stack }, 'err');
        bindUi(null);
      }
    }

    function bindUi(tg) {
      const sendBtn = document.getElementById('sendBtn');
      const clearBtn = document.getElementById('clearBtn');

      sendBtn.addEventListener('click', () => {
        log(`Кнопка 'Отправить' нажата`);
        if (tg) {
          try {
            tg.sendData(displayName);
            log('Данные отправлены в бота', { sentData: displayName }, 'ok');
            tg.close();
            log('WebApp закрыт пользователем');
          } catch (e) {
            log('sendData/close error', { message: e.message, stack: e.stack }, 'err');
          }
        } else {
          log('Нет Telegram WebApp контекста — отправка невозможна', null, 'warn');
          alert(`Локально бы отправили: "${displayName}" — откройте через кнопку бота`);
        }
      });

      clearBtn.addEventListener('click', () => { logEl.textContent = ''; log('Лог очищен'); });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
